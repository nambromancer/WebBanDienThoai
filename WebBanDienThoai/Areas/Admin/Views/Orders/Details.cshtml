@model WebBanDienThoai.Models.Order

@{
    ViewBag.Title = "Chi tiết đơn hàng #" + Model.OrderID;
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    // Tính toán phí ship và tổng sản phẩm
    decimal productTotal = 0;
    if (Model.OrderDetails != null && Model.OrderDetails.Any())
    {
        productTotal = Model.OrderDetails.Sum(od => od.TotalPrice.HasValue ? od.TotalPrice.Value : (od.UnitPrice * od.Quantity));
    }

    decimal shippingFee = 0;
    if (Model.DeliveryMethod == "Giao hàng nhanh")
    {
        shippingFee = 30000;
    }

    // ✅ Xác định quyền thao tác - CẬP NHẬT
    var canEdit = Model.OrderStatus != "Đã hủy" && Model.OrderStatus != "Đã giao hàng";
    var canDelete = Model.OrderStatus == "Đã hủy";
    var canUpdateStatus = Model.OrderStatus != "Đã hủy" && Model.OrderStatus != "Đã giao hàng";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2><i class="fas fa-file-invoice"></i> Chi tiết đơn hàng #@Model.OrderID</h2>
            <div class="btn-toolbar" role="toolbar">
                <div class="btn-group mr-2">
                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                        Quay lại
                    </a>
                    @if (canEdit)
                    {
                        <a href="@Url.Action("Edit", new { id = Model.OrderID })" class="btn btn-primary">
                            Chỉnh sửa
                        </a>
                    }
                    @if (canDelete)
                    {
                        <a href="@Url.Action("Delete", new { id = Model.OrderID })" class="btn btn-danger">
                            Xóa
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Order Status Card -->
        <div class="col-md-12 mb-3">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-info-circle"></i> Trạng thái đơn hàng
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>
                                Trạng thái:
                                @{
                                    var statusClass = "";
                                    switch (Model.OrderStatus)
                                    {
                                        case "Chờ xử lý": statusClass = "badge-warning"; break;
                                        case "Đang xử lý": statusClass = "badge-info"; break;
                                        case "Đang giao hàng": statusClass = "badge-primary"; break;
                                        case "Đã giao hàng": statusClass = "badge-success"; break;
                                        case "Đã hủy": statusClass = "badge-danger"; break;
                                    }
                                }
                                <span class="badge @statusClass" style="font-size: 14px;">@Model.OrderStatus</span>
                            </h5>
                        </div>
                        <div class="col-md-6">
                            <h5>
                                Thanh toán:
                                <span class="badge @(Model.PaymentStatus == "Đã thanh toán" ? "badge-success" : "badge-secondary")" style="font-size: 14px;">
                                    @Model.PaymentStatus
                                </span>
                            </h5>
                        </div>
                    </div>
                    @if (canUpdateStatus)
                    {
                        <hr />
                        <div class="row">
                            <div class="col-md-12">
                                <label>Cập nhật trạng thái nhanh:</label>
                                <select id="quickStatusUpdate" class="form-control form-control-sm" style="max-width: 300px; display: inline-block;">
                                    <option value="">-- Chọn trạng thái --</option>
                                    @if (Model.OrderStatus == "Chờ xử lý")
                                    {
                                        <option value="Đang xử lý">Đang xử lý</option>
                                        <option value="Đã hủy">Đã hủy</option>
                                    }
                                    else if (Model.OrderStatus == "Đang xử lý")
                                    {
                                        <option value="Đang giao hàng">Đang giao hàng</option>
                                        <option value="Đã hủy">Đã hủy</option>
                                    }
                                    else if (Model.OrderStatus == "Đang giao hàng")
                                    {
                                        <option value="Đã giao hàng">Đã giao hàng</option>
                                        <option value="Đã hủy">Đã hủy</option>
                                    }
                                </select>
                                <button onclick="updateOrderStatus()" class="btn btn-sm btn-primary ml-2">
                                    Cập nhật
                                </button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <hr />
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i>
                            @if (Model.OrderStatus == "Đã hủy")
                            {
                                <span>Đơn hàng đã hủy - Không thể thay đổi trạng thái. Bạn có thể xóa đơn hàng này.</span>
                            }
                            else if (Model.OrderStatus == "Đã giao hàng")
                            {
                                <span>Đơn hàng đã giao thành công - Không thể thay đổi trạng thái đơn hàng.</span>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Customer Info Card -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-user"></i> Thông tin khách hàng
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Họ tên:</dt>
                        <dd class="col-sm-8">@Model.Customer.CustomerName</dd>

                        <dt class="col-sm-4">Số điện thoại:</dt>
                        <dd class="col-sm-8">@Model.Customer.PhoneNumber</dd>

                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8">@(Model.Customer.CustomerEmail ?? "N/A")</dd>

                        <dt class="col-sm-4">Địa chỉ giao:</dt>
                        <dd class="col-sm-8">@Model.AddressDelivery</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Order Info Card -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-shopping-cart"></i> Thông tin đơn hàng
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Mã đơn hàng:</dt>
                        <dd class="col-sm-7"><strong>#@Model.OrderID</strong></dd>

                        <dt class="col-sm-5">Ngày đặt:</dt>
                        <dd class="col-sm-7">@(Model.OrderDate.HasValue ? Model.OrderDate.Value.ToString("dd/MM/yyyy HH:mm") : "N/A")</dd>

                        <dt class="col-sm-5">Phương thức giao:</dt>
                        <dd class="col-sm-7">@Model.DeliveryMethod</dd>

                        <dt class="col-sm-5">Thanh toán:</dt>
                        <dd class="col-sm-7">@Model.PaymentMethod</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="fas fa-box"></i> Sản phẩm đã đặt
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th width="10%">Hình ảnh</th>
                                    <th width="40%">Tên sản phẩm</th>
                                    <th width="15%" class="text-right">Đơn giá</th>
                                    <th width="10%" class="text-center">Số lượng</th>
                                    <th width="15%" class="text-right">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detail in Model.OrderDetails)
                                {
                                    var productImage = detail.Product.ProductImages != null && detail.Product.ProductImages.Any()
                                        ? Url.Content(detail.Product.ProductImages.OrderBy(i => i.DisplayOrder.HasValue ? i.DisplayOrder.Value : int.MaxValue).First().ImageURL)
                                        : Url.Content(detail.Product.ProductImage ?? "~/Content/Images/no-image.png");

                                    <tr>
                                        <td>
                                            <img src="@productImage" alt="@detail.Product.ProductName"
                                                 class="img-thumbnail" style="max-height: 60px;" />
                                        </td>
                                        <td>
                                            <strong>@detail.Product.ProductName</strong><br />
                                            <small class="text-muted">Mã SP: #@detail.ProductID</small>
                                        </td>
                                        <td class="text-right">@String.Format("{0:N0} ₫", detail.UnitPrice)</td>
                                        <td class="text-center"><strong>@detail.Quantity</strong></td>
                                        <td class="text-right text-danger font-weight-bold">
                                            @String.Format("{0:N0} ₫", detail.TotalPrice.HasValue ? detail.TotalPrice.Value : (detail.UnitPrice * detail.Quantity))
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="4" class="text-right"><strong>Tạm tính:</strong></td>
                                    <td class="text-right">@String.Format("{0:N0} ₫", productTotal)</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-right"><strong>Phí vận chuyển:</strong></td>
                                    <td class="text-right text-success">
                                        @if (shippingFee > 0)
                                        {
                                            @String.Format("{0:N0} ₫", shippingFee)
                                        }
                                        else
                                        {
                                            <text>Miễn phí</text>
                                        }
                                    </td>
                                </tr>
                                <tr class="table-primary">
                                    <td colspan="4" class="text-right"><h5 class="mb-0"><strong>Tổng cộng:</strong></h5></td>
                                    <td class="text-right"><h5 class="mb-0 text-danger"><strong>@String.Format("{0:N0} ₫", Model.TotalAmount)</strong></h5></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        function updateOrderStatus() {
            var newStatus = $('#quickStatusUpdate').val();
            if (!newStatus) {
                alert('Vui lòng chọn trạng thái!');
                return;
            }

            if (!confirm('Bạn có chắc muốn cập nhật trạng thái đơn hàng?')) {
                return;
            }

            $.ajax({
                url: '@Url.Action("UpdateStatus", "Orders")',
                type: 'POST',
                data: {
                    orderId: @Model.OrderID,
                    status: newStatus
                },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Có lỗi xảy ra. Vui lòng thử lại!');
                }
            });
        }
    </script>
}

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-header {
        font-weight: 600;
    }

    dl dt {
        font-weight: 600;
        color: #495057;
    }

    dl dd {
        color: #212529;
    }
</style>