@model WebBanDienThoai.Models.ViewModel.SearchCustomerVM
@using PagedList.Mvc

@{
    ViewBag.Title = "Quản lý khách hàng";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Quản lý khách hàng</title>
    <style>
        .search-container {
            padding-top: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .form-group-inline {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

            .form-group-inline label {
                font-weight: bold;
                margin-bottom: 5px;
            }

        .button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .order-container {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }

            .order-container a {
                margin: 0 5px;
            }

        .filter-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .table thead th {
            vertical-align: middle;
            text-align: center;
        }

        .table tbody td {
            vertical-align: middle;
        }

        .badge {
            font-size: 14px;
            padding: 5px 10px;
        }

        .add-button-container {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <h2 class="bg-primary text-white" style="padding: 15px;">
        <i class="fas fa-users"></i> QUẢN LÝ KHÁCH HÀNG
    </h2>

    @* Hiển thị thông báo *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Form tìm kiếm và lọc -->
    @using (Html.BeginForm("Index", "Customers", FormMethod.Get))
    {
        <div class="search-container">
            <div class="filter-row">
                <div class="form-group-inline">
                    <label>Tìm kiếm</label>
                    @Html.TextBox("searchTerm", Model.SearchTerm, new { @class = "form-control", placeholder = "Tên, Email, SĐT..." })
                </div>

                <div class="form-group-inline">
                    <label>Giới tính</label>
                    @Html.DropDownList("genderFilter", ViewBag.GenderList as SelectList, new { @class = "form-control" })
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                    <a href="@Url.Action("Index", "Customers")" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Xóa bộ lọc
                    </a>
                </div>
            </div>

            @* Hiển thị thông tin lọc *@
            @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.GenderFilter))
            {
                <div class="filter-info">
                    <i class="fas fa-filter"></i>
                    <strong>Đang lọc:</strong>
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <span>Từ khóa: "<strong>@Model.SearchTerm</strong>"</span>
                    }
                    @if (!string.IsNullOrEmpty(Model.GenderFilter))
                    {
                        <span>| Giới tính: <strong>@Model.GenderFilter</strong></span>
                    }
                    <span>- Tìm thấy <strong>@Model.Customers.TotalItemCount</strong> khách hàng</span>
                </div>
            }
        </div>

        <div class="order-container">
            Sắp xếp theo:
            @Html.ActionLink("Tên tăng dần", "Index",
                               new { sortOrder = "", searchTerm = Model.SearchTerm, genderFilter = Model.GenderFilter })
            |
            @Html.ActionLink("Tên giảm dần", "Index",
                               new { sortOrder = "name_desc", searchTerm = Model.SearchTerm, genderFilter = Model.GenderFilter })
            |
            @Html.ActionLink("Email (A-Z)", "Index",
                               new { sortOrder = "email_asc", searchTerm = Model.SearchTerm, genderFilter = Model.GenderFilter })
            |
            @Html.ActionLink("Email (Z-A)", "Index",
                               new { sortOrder = "email_desc", searchTerm = Model.SearchTerm, genderFilter = Model.GenderFilter })
        </div>
    }

    @* Nút thêm mới *@
    <div class="add-button-container">
        @Html.ActionLink("Thêm khách hàng mới", "Create", null, new { @class = "btn btn-success" })
    </div>

    @* Bảng danh sách khách hàng *@
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Số điện thoại</th>
                    <th>Địa chỉ</th>
                    <th>Ngày sinh</th>
                    <th>Giới tính</th>
                    <th>Số đơn hàng</th>
                    <th style="width: 250px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Customers != null && Model.Customers.Any())
                {
                    foreach (var customer in Model.Customers)
                    {
                        <tr>
                            <td>@customer.CustomerID</td>
                            <td>
                                <strong>@customer.CustomerName</strong>
                            </td>
                            <td>
                                <i class="fas fa-envelope"></i> @customer.CustomerEmail
                            </td>
                            <td>
                                <i class="fas fa-phone"></i> @customer.PhoneNumber
                            </td>
                            <td>
                                @if (!string.IsNullOrWhiteSpace(customer.CustomerAddress))
                                {
                                    <span>@customer.CustomerAddress</span>
                                }
                                else
                                {
                                    <span class="text-muted">Chưa cập nhật</span>
                                }
                            </td>
                            <td>
                                @if (customer.DateOfBirth.HasValue)
                                {
                                    <span>@customer.DateOfBirth.Value.ToString("dd/MM/yyyy")</span>
                                }
                                else
                                {
                                    <span class="text-muted">Chưa cập nhật</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrWhiteSpace(customer.Gender))
                                {
                                    if (customer.Gender == "Nam")
                                    {
                                        <span class="badge badge-primary"><i class="fas fa-mars"></i> Nam</span>
                                    }
                                    else if (customer.Gender == "Nữ")
                                    {
                                        <span class="badge badge-danger"><i class="fas fa-venus"></i> Nữ</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary">@customer.Gender</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">Chưa cập nhật</span>
                                }
                            </td>
                            <td class="text-center">
                                @{
                                    var orderCount = customer.Orders != null ? customer.Orders.Count() : 0;
                                    if (orderCount > 0)
                                    {
                                        <span class="badge badge-info">@orderCount</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary">0</span>
                                    }
                                }
                            </td>
                            <td>
                                @Html.ActionLink("Cập nhật", "Edit", new { id = customer.CustomerID }, new { @class = "btn btn-primary btn-sm" })
                                @Html.ActionLink("Chi tiết", "Details", new { id = customer.CustomerID }, new { @class = "btn btn-info btn-sm" })
                                @Html.ActionLink("Xóa", "Delete", new { id = customer.CustomerID }, new { @class = "btn btn-danger btn-sm" })
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="9" class="text-center">
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle"></i>
                                Không tìm thấy khách hàng nào.
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* Phân trang *@
    @if (Model.Customers != null && Model.Customers.PageCount > 1)
    {
        <div class="text-center">
            <ul class="pagination">
                @Html.PagedListPager(Model.Customers, page => Url.Action("Index",
                                   new
                                   {
                                       page,
                                       searchTerm = Model.SearchTerm,
                                       genderFilter = Model.GenderFilter,
                                       sortOrder = Model.SortOrder
                                   }))
            </ul>
            <p class="text-muted">
                Trang @Model.Customers.PageNumber / @Model.Customers.PageCount
                (Tổng: @Model.Customers.TotalItemCount khách hàng)
            </p>
        </div>
    }

</body>
</html>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Auto dismiss alerts after 5 seconds
            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 5000);
        });
    </script>
}