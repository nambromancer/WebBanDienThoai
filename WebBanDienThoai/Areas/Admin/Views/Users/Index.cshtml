@model WebBanDienThoai.Models.ViewModel.SearchUserVM
@using PagedList.Mvc

@{
    ViewBag.Title = "Quản lý tài khoản";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Quản lý tài khoản</title>
    <style>
        .search-container {
            padding-top: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .form-group-inline {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

            .form-group-inline label {
                font-weight: bold;
                margin-bottom: 5px;
            }

        .button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .order-container {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }

            .order-container a {
                margin: 0 5px;
            }

        .filter-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .table thead th {
            vertical-align: middle;
            text-align: center;
        }

        .table tbody td {
            vertical-align: middle;
        }

        .badge {
            font-size: 14px;
            padding: 5px 10px;
        }

        .add-button-container {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <h2 class="bg-dark text-white" style="padding: 15px;">
        <i class="fas fa-user-lock"></i> QUẢN LÝ TÀI KHOẢN
    </h2>

    @* Hiển thị thông báo *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Form tìm kiếm và lọc -->
    @using (Html.BeginForm("Index", "Users", FormMethod.Get))
    {
        <div class="search-container">
            <div class="filter-row">
                <div class="form-group-inline">
                    <label>Tìm kiếm</label>
                    @Html.TextBox("searchTerm", Model.SearchTerm, new { @class = "form-control", placeholder = "Số điện thoại..." })
                </div>

                <div class="form-group-inline">
                    <label>Vai trò</label>
                    @Html.DropDownList("roleFilter", ViewBag.RoleList as SelectList, new { @class = "form-control" })
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                    <a href="@Url.Action("Index", "Users")" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Xóa bộ lọc
                    </a>
                </div>
            </div>

            @* Hiển thị thông tin lọc *@
            @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.RoleFilter))
            {
                <div class="filter-info">
                    <i class="fas fa-filter"></i>
                    <strong>Đang lọc:</strong>
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <span>Từ khóa: "<strong>@Model.SearchTerm</strong>"</span>
                    }
                    @if (!string.IsNullOrEmpty(Model.RoleFilter))
                    {
                        var roleName = Model.RoleFilter == "0" ? "Admin" : "Khách hàng";
                        <span>| Vai trò: <strong>@roleName</strong></span>
                    }
                    <span>- Tìm thấy <strong>@Model.Users.TotalItemCount</strong> tài khoản</span>
                </div>
            }
        </div>

        <div class="order-container">
            Sắp xếp theo:
            @Html.ActionLink("SĐT tăng dần", "Index",
                               new { sortOrder = "", searchTerm = Model.SearchTerm, roleFilter = Model.RoleFilter })
            |
            @Html.ActionLink("SĐT giảm dần", "Index",
                               new { sortOrder = "phone_desc", searchTerm = Model.SearchTerm, roleFilter = Model.RoleFilter })
            |
            @Html.ActionLink("Vai trò (A-Z)", "Index",
                               new { sortOrder = "role_asc", searchTerm = Model.SearchTerm, roleFilter = Model.RoleFilter })
            |
            @Html.ActionLink("Vai trò (Z-A)", "Index",
                               new { sortOrder = "role_desc", searchTerm = Model.SearchTerm, roleFilter = Model.RoleFilter })
            |
            @Html.ActionLink("Ngày tạo (Cũ-Mới)", "Index",
                               new { sortOrder = "date_asc", searchTerm = Model.SearchTerm, roleFilter = Model.RoleFilter })
            |
            @Html.ActionLink("Ngày tạo (Mới-Cũ)", "Index",
                               new { sortOrder = "date_desc", searchTerm = Model.SearchTerm, roleFilter = Model.RoleFilter })
        </div>
    }

    @* Nút thêm mới *@
    <div class="add-button-container">
        @Html.ActionLink("Thêm tài khoản mới", "Create", null, new { @class = "btn btn-success" })
    </div>

    @* Bảng danh sách tài khoản *@
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Số điện thoại</th>
                    <th>Vai trò</th>
                    <th>Ngày tạo</th>
                    <th>Số khách hàng</th>
                    <th style="width: 250px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Users != null && Model.Users.Any())
                {
                    foreach (var user in Model.Users)
                    {
                        <tr>
                            <td>
                                <i class="fas fa-phone"></i> <strong>@user.PhoneNumber</strong>
                            </td>
                            <td>
                                @if (user.UserRole == "0")
                                {
                                    <span class="badge badge-danger">
                                        <i class="fas fa-user-shield"></i> Admin
                                    </span>
                                }
                                else if (user.UserRole == "1")
                                {
                                    <span class="badge badge-info">
                                        <i class="fas fa-user"></i> Khách hàng
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">@user.UserRole</span>
                                }
                            </td>
                            <td>
                                @if (user.CreatedDate.HasValue)
                                {
                                    <span>@user.CreatedDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td class="text-center">
                                @{
                                    var customerCount = user.Customers != null ? user.Customers.Count() : 0;
                                    if (customerCount > 0)
                                    {
                                        <span class="badge badge-success">@customerCount</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary">0</span>
                                    }
                                }
                            </td>
                            <td>
                                @Html.ActionLink("Cập nhật", "Edit", new { id = user.PhoneNumber }, new { @class = "btn btn-primary btn-sm" })
                                @Html.ActionLink("Chi tiết", "Details", new { id = user.PhoneNumber }, new { @class = "btn btn-info btn-sm" })
                                @Html.ActionLink("Xóa", "Delete", new { id = user.PhoneNumber }, new { @class = "btn btn-danger btn-sm" })
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle"></i>
                                Không tìm thấy tài khoản nào.
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* Phân trang *@
    @if (Model.Users != null && Model.Users.PageCount > 1)
    {
        <div class="text-center">
            <ul class="pagination">
                @Html.PagedListPager(Model.Users, page => Url.Action("Index",
                                   new
                                   {
                                       page,
                                       searchTerm = Model.SearchTerm,
                                       roleFilter = Model.RoleFilter,
                                       sortOrder = Model.SortOrder
                                   }))
            </ul>
            <p class="text-muted">
                Trang @Model.Users.PageNumber / @Model.Users.PageCount
                (Tổng: @Model.Users.TotalItemCount tài khoản)
            </p>
        </div>
    }

</body>
</html>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Auto dismiss alerts after 5 seconds
            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 5000);
        });
    </script>
}