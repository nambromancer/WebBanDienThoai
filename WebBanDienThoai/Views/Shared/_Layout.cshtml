
@{
    // Lấy danh sách categories từ database
    var db = new WebBanDienThoai.Models.WebBanDienThoaiDBEntities();
    var categories = db.Categories.OrderBy(c => c.CategoryID).ToList();

    // Lấy thông tin user từ Session
    var userName = Session["UserName"] as string;
    var isLoggedIn = !string.IsNullOrEmpty(userName);

    // Lấy số lượng sản phẩm trong giỏ hàng
    var cart = Session["Cart"] as List<WebBanDienThoai.Models.ViewModel.CartItem>;
    var cartCount = cart != null ? cart.Sum(c => c.Quantity) : 0;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Thế Giới Di Động</title>

    @Styles.Render("~/Content/css")
    <link href="~/Content/header-style.css" rel="stylesheet" />
    <link href="~/Content/footer-style.css" rel="stylesheet" />
    <link href="~/Content/modal-tgdd.css" rel="stylesheet" />
    <link href="~/Content/responsive-customer.css" rel="stylesheet" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    @RenderSection("Styles", required: false)

    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <header class="main-header" role="banner">
        <div class="header-container">
            <div class="logo-section">
                <a href="@Url.Action("Index", "Home")" class="logo-link" aria-label="Về trang chủ">
                    <div class="logo-circle">
                        <span class="logo-icon"><i class="fas fa-mobile-alt"></i></span>
                    </div>
                    <span class="logo-text">thegioididong</span>
                </a>
            </div>

            <div class="search-section" role="search" aria-label="Tìm kiếm">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Laptop nhập học..." aria-label="Từ khóa tìm kiếm">
                    <button class="search-btn" type="button" aria-label="Tìm kiếm">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                    </button>
                </div>
            </div>

            <div class="user-actions" aria-label="Tác vụ người dùng">
                @if (isLoggedIn)
                {
                    <div class="user-dropdown">
                        <a href="javascript:void(0)" class="user-login user-logged-in">
                            <span class="user-icon"><i class="fas fa-user"></i></span>
                            <span class="user-name">@userName</span>
                        </a>
                        <div class="dropdown-menu">
                            <a href="@Url.Action("UserProfile", "Account")" class="dropdown-item">
                                <span class="dropdown-icon"><i class="fas fa-info-circle"></i></span>
                                Thông tin cá nhân
                            </a>
                            <a href="@Url.Action("PurchaseHistory", "Account")" class="dropdown-item">
                                <span class="dropdown-icon"><i class="fas fa-box"></i></span>
                                Lịch sử mua hàng
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="@Url.Action("Logout", "Account")" class="dropdown-item logout-item">
                                <span class="dropdown-icon"><i class="fas fa-sign-out-alt"></i></span>
                                Đăng xuất
                            </a>
                        </div>
                    </div>
                }
                else
                {
                    <a id="loginLink"
                       href="javascript:void(0)"
                       class="user-login"
                       data-toggle="modal" data-target="#loginModal"
                       data-bs-toggle="modal" data-bs-target="#loginModal">
                        <span class="user-icon"><i class="fas fa-user"></i></span>
                        <span>Đăng nhập</span>
                    </a>
                }

                <a href="@Url.Action("Cart","Home")" class="cart-link" aria-label="Xem giỏ hàng" style="position: relative;">
                    <span class="cart-icon"><i class="fas fa-shopping-cart"></i></span>
                    <span>Giỏ hàng</span>
                    <span class="cart-badge" id="cartBadge" style="display: @(cartCount > 0 ? "inline-block" : "none");">@cartCount</span>
                </a>
                <div class="location" aria-label="Vị trí hiện tại">
                    <span class="location-icon"><i class="fas fa-map-marker-alt"></i></span>
                    <span>Hồ Chí Minh</span>
                </div>
            </div>
        </div>

        <nav class="main-navigation" aria-label="Danh mục chính">
            <div class="nav-container">
                <ul class="nav-menu">
                    @foreach (var category in categories)
                    {
                        string icon = "fa-mobile-alt";
                        var catNameLower = category.CategoryName.ToLower();
                        if (catNameLower.Contains("điện thoại") || catNameLower.Contains("phone"))
                        {
                            icon = "fa-mobile-alt";
                        }
                        else if (catNameLower.Contains("laptop"))
                        {
                            icon = "fa-laptop";
                        }
                        else if (catNameLower.Contains("phụ kiện") || catNameLower.Contains("accessory"))
                        {
                            icon = "fa-plug";
                        }
                        else if (catNameLower.Contains("smartwatch") || catNameLower.Contains("đồng hồ"))
                        {
                            icon = "fa-clock";
                        }
                        else if (catNameLower.Contains("tablet"))
                        {
                            icon = "fa-tablet-alt";
                        }

                        <li class="nav-item">
                            <a href="@Url.Action("Index", "Products", new { categoryId = category.CategoryID })" class="nav-link">
                                <span class="nav-icon"><i class="fas @icon"></i></span>
                                @category.CategoryName
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </nav>
    </header>

    <div class="modal fade tgdd-modal"
         id="loginModal"
         tabindex="-1"
         role="dialog"
         aria-labelledby="loginModalLabel"
         aria-modal="true"
         aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <button type="button"
                        class="close tgdd-close"
                        data-dismiss="modal"
                        data-bs-dismiss="modal"
                        aria-label="Đóng">
                    x
                </button>
                <div class="modal-body text-center">
                    <h3 id="loginModalLabel" class="tgdd-title">thegioididong</h3>
                    <p class="tgdd-desc">
                        Vui lòng đăng nhập tài khoản thegioididong để xem ưu đãi và thanh toán dễ dàng hơn.
                    </p>
                    <div class="tgdd-actions">
                        <a href="@Url.Action("Register", "Account")" class="btn btn-outline-tgdd">Đăng ký</a>
                        <a href="@Url.Action("Login", "Account")" class="btn btn-tgdd">Đăng nhập</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container body-content">
        @RenderBody()
        <hr />
    </div>

    <footer role="contentinfo">
        <div class="footer-top">
            <div class="footer-container">
                <div class="footer-columns">
                    <div class="footer-col">
                        <h4>Tổng đài hỗ trợ</h4>
                        <ul>
                            <li>Gọi mua: <a href="tel:18001060">1800 1060</a> (7:30 - 22:00)</li>
                            <li>Khiếu nại: <a href="tel:18001062">1800 1062</a> (8:00 - 21:30)</li>
                            <li>Bảo hành: <a href="tel:18001064">1800 1064</a> (8:00 - 21:00)</li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Về công ty</h4>
                        <ul>
                            <li><a href="#">Giới thiệu công ty (MWG.vn)</a></li>
                            <li><a href="#">Tuyển dụng</a></li>
                            <li><a href="#">Gửi góp ý, khiếu nại</a></li>
                            <li><a href="#">Tìm siêu thị (gần bạn)</a></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Thông tin khác</h4>
                        <ul>
                            <li><a href="#">Trung tâm bảo hành</a></li>
                            <li><a href="#">Chính sách bảo hành</a></li>
                            <li><a href="#">Hướng dẫn mua hàng</a></li>
                            <li><a href="#">Bảo mật và điều khoản</a></li>
                        </ul>
                    </div>
                    <div class="footer-col">
                        <h4>Website cùng tập đoàn</h4>
                        <div class="partner-badges">
                            <a href="#" class="badge">TopZone</a>
                            <a href="#" class="badge">Điện máy XANH</a>
                            <a href="#" class="badge">Bách hóa XANH</a>
                            <a href="#" class="badge">Nhà thuốc An Khang</a>
                        </div>
                        <div class="socials">
                            <a href="#" class="social">Facebook</a>
                            <a href="#" class="social">YouTube</a>
                            <a href="#" class="social">Zalo</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="footer-container">
                <p>© @DateTime.Now.Year - Thế Giới Di Động. Nội dung mang tính minh họa cho bài thực hành.</p>
            </div>
        </div>
    </footer>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)

    <script>
        (function () {
            'use strict';

            function showLoginModal(e) {
                if (e) e.preventDefault();
                var modalEl = document.getElementById('loginModal');
                if (!modalEl) return;

                if (window.jQuery && typeof jQuery.fn.modal === 'function') {
                    jQuery(modalEl).modal('show');
                    return;
                }
                if (window.bootstrap && typeof bootstrap.Modal === 'function') {
                    (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl)).show();
                    return;
                }
                modalEl.classList.add('in', 'show');
                modalEl.style.display = 'block';
                modalEl.setAttribute('aria-hidden', 'false');
                document.body.classList.add('modal-open');
            }

            function hideLoginModal(e) {
                if (e) e.preventDefault();
                var modalEl = document.getElementById('loginModal');
                if (!modalEl) return;

                if (window.jQuery && typeof jQuery.fn.modal === 'function') {
                    jQuery(modalEl).modal('hide');
                    return;
                }
                if (window.bootstrap && typeof bootstrap.Modal === 'function') {
                    (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl)).hide();
                    return;
                }
                modalEl.classList.remove('in', 'show');
                modalEl.style.display = 'none';
                modalEl.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('modal-open');
                var backdrop = document.querySelector('.modal-backdrop');
                if (backdrop && backdrop.parentNode) backdrop.parentNode.removeChild(backdrop);
            }

            document.addEventListener('click', function (ev) {
                var trigger = ev.target && ev.target.closest ? ev.target.closest('#loginLink') : null;
                if (trigger) showLoginModal(ev);
            });

            if (window.jQuery) {
                jQuery(document).on('click', '#loginModal .tgdd-close', hideLoginModal);
            } else {
                document.addEventListener('click', function (ev) {
                    var closeBtn = ev.target && ev.target.closest ? ev.target.closest('#loginModal .tgdd-close') : null;
                    if (closeBtn) hideLoginModal(ev);
                });
            }
        })();

        (function () {
            'use strict';
            var input = document.querySelector('.search-input');
            var btn = document.querySelector('.search-btn');
            if (!input) return;

            function gotoSearch() {
                var q = (input.value || '').trim();
                var baseUrl = '@Url.Content("~/Search/Index")';
                var url = baseUrl + (q ? ('?q=' + encodeURIComponent(q)) : '');
                window.location.href = url;
            }

            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') { e.preventDefault(); gotoSearch(); }
            });
            if (btn) btn.addEventListener('click', gotoSearch);
        })();

        (function () {
            'use strict';

            var userDropdown = document.querySelector('.user-dropdown');
            if (!userDropdown) return;

            var closeTimer = null;

            userDropdown.addEventListener('mouseenter', function () {
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
                userDropdown.classList.add('active');
            });

            userDropdown.addEventListener('mouseleave', function () {
                closeTimer = setTimeout(function () {
                    userDropdown.classList.remove('active');
                }, 200);
            });

            var userToggle = userDropdown.querySelector('.user-logged-in');
            if (userToggle) {
                userToggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    userDropdown.classList.toggle('active');
                });
            }

            document.addEventListener('click', function (e) {
                if (!userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    userDropdown.classList.remove('active');
                }
            });
        })();

        // Hàm cập nhật badge giỏ hàng
        window.updateCartBadge = function(count) {
            var badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        };
    </script>
</body>
</html>