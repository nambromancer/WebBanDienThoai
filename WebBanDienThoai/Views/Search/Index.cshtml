@model List<WebBanDienThoai.Models.Product>
@{
    ViewBag.Title = "Tìm kiếm";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var q = (ViewBag.Query as string) ?? "";
    var total = (ViewBag.Total as int?) ?? (Model != null ? Model.Count : 0);
}
<link href="~/Content/category.css" rel="stylesheet" />

<div class="cat-wrap container">
    <nav class="cat-breadcrumb">
        <a class="home-link" href="@Url.Action("Index","Home")">Trang chủ</a>
        <span class="sep">›</span>
        <span>Kết quả cho "@Html.Encode(q)" • <strong>@total</strong> sản phẩm</span>
    </nav>

    <!-- Product list -->
    <div class="product-list js-product-list">
        @if (Model != null && Model.Any())
        {
            <div class="product-grid">
                @foreach (var product in Model)
                {
                    var firstImage = product.ProductImages != null && product.ProductImages.Any()
                        ? Url.Content(product.ProductImages.OrderBy(i => i.DisplayOrder ?? int.MaxValue).First().ImageURL)
                        : !string.IsNullOrWhiteSpace(product.ProductImage)
                            ? Url.Content(product.ProductImage)
                            : Url.Content("~/Content/Images/no-image.png");

                    var discount = product.OriginalPrice.HasValue && product.OriginalPrice > product.ProductPrice
                        ? Math.Round((1 - (product.ProductPrice / product.OriginalPrice.Value)) * 100)
                        : 0;

                    <article class="product-card">
                        @if (discount > 0)
                        {
                            <div class="card-topline">
                                <span class="pill mint">Trả góp 0%</span>
                                <span class="pill flash-sale">Flash Sale</span>
                            </div>
                        }

                        <a href="@Url.Action("ProductDetail", "Products", new { id = product.ProductID })" class="product-thumb" aria-label="@product.ProductName">
                            <img class="thumb-img"
                                 src="@firstImage"
                                 alt="@product.ProductName"
                                 loading="lazy"
                                 decoding="async" />
                        </a>

                        <h3 class="product-name">
                            <a href="@Url.Action("ProductDetail", "Products", new { id = product.ProductID })">
                                @product.ProductName
                            </a>
                        </h3>

                        <div class="price-line">
                            <span class="price">@String.Format("{0:N0}₫", product.ProductPrice)</span>
                            @if (product.OriginalPrice.HasValue && product.OriginalPrice > product.ProductPrice)
                            {
                                <span class="price-old">@String.Format("{0:N0}₫", product.OriginalPrice.Value)</span>
                                <span class="discount">-@discount%</span>
                            }
                        </div>
                    </article>
                }
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center" style="grid-column: 1/-1;">
                <i class="fas fa-exclamation-triangle"></i> Không tìm thấy sản phẩm phù hợp.
            </div>
        }
    </div>

    <!-- Load more button -->
    @if (Model != null && Model.Count > 15)
    {
        <div class="load-more-wrap">
            <button type="button" class="load-more-btn js-load-more" data-itemname="sản phẩm">
                Xem thêm <span class="js-remaining-count">0</span> sản phẩm
            </button>
        </div>
    }
</div>

<script>(function () {
        // Load more
        var list = document.querySelector('.js-product-list') || document;
        var cardSelector = '.product-card';
        var pageSize = 15;
        var cards = Array.from(list.querySelectorAll(cardSelector));
        cards.forEach(function (c, i) { if (i >= pageSize) c.classList.add('is-hidden-loadmore'); });
        var btn = document.querySelector('.js-load-more');
        var remainingEl = document.querySelector('.js-remaining-count');
        var updateRemaining = function () {
            var remaining = list.querySelectorAll(cardSelector + '.is-hidden-loadmore').length;
            if (remainingEl) remainingEl.textContent = String(remaining);
            if (btn) btn.classList.toggle('hidden', remaining <= 0);
        };
        updateRemaining();
        btn && btn.addEventListener('click', function () {
            var hidden = Array.from(list.querySelectorAll(cardSelector + '.is-hidden-loadmore')).slice(0, pageSize);
            hidden.forEach(function (el) { el.classList.remove('is-hidden-loadmore'); });
            updateRemaining();
        });
    })();</script>